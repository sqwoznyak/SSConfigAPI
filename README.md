# SSConfigAPI
Этот проект реализует систему взаимодействия клиента с сервером, использующую Shadowsocks, Nginx и FastAPI для динамической генерации ключей и управления доступом.
- [Описание работы системы](Описание-работы-системы)
- [Быстрый старт](#быстрый-старт)
- [main.py](#mainpy)
- [install_outline_vpn.sh](#install_outline_vpnsh)
- [install_nginx_proxy.sh](#install_nginx_proxysh)
## Описание работы системы

## Архитектура

1. **Клиент** отправляет запрос по протоколу `ssconf`, используя динамический ключ.
2. Запрос направляется на **сервер**, на котором развернут **Nginx**.
3. **Nginx** проксирует запрос к **службе**, работающей на сервере через **FastAPI**.
4. Служба, получив запрос, обрабатывает его, определяя, какой ключ соответствует запросу клиента.
5. После этого служба формирует и отправляет клиенту ответ в формате **JSON**, содержащий необходимые поля для подключения к серверу с работающим Shadowsocks.

## Пример взаимодействия

Клиент отправляет запрос с динамическим ключом через протокол `ssconf`, который передается на сервер, где через Nginx он перенаправляется на службу FastAPI.

### Пример запроса:
```
ssconf://users.outline.yourvpn.io/conf/qwerty1235e0x112dd2exz#Wow!
```
### Пример ответа
Служба FastAPI возвращает JSON-ответ, который содержит поля, необходимые для настройки подключения к Shadowsocks:

```json
{
  "server": "shadowsocks.example.com",
  "server_port": 8388,
  "password": "generated_password",
  "method": "aes-256-gcm",
  "timeout": 300
}

```


## Быстрый старт

Это руководство предназначено для быстрой установки и запуска FastAPI-приложения с использованием Gunicorn и systemd на сервере с Ubuntu.

### Содержание

- [SSConfigAPI](#ssconfigapi)
  - [Описание работы системы](#описание-работы-системы)
  - [Архитектура](#архитектура)
  - [Пример взаимодействия](#пример-взаимодействия)
    - [Пример запроса:](#пример-запроса)
    - [Пример ответа](#пример-ответа)
  - [Быстрый старт](#быстрый-старт)
    - [Содержание](#содержание)
    - [Предварительные требования](#предварительные-требования)
    - [Быстрая установка](#быстрая-установка)
    - [Установка и настройка](#установка-и-настройка)
      - [Установка зависимостей](#установка-зависимостей)
      - [Создание виртуального окружения](#создание-виртуального-окружения)
      - [Настройка и запуск приложения](#настройка-и-запуск-приложения)
    - [Проверка работоспособности](#проверка-работоспособности)
    - [Логи](#логи)
    - [Полезные команды](#полезные-команды)
    - [Справка](#справка)
  - [main.py](#mainpy)
    - [Описание функций](#описание-функций)
    - [Описание мидлварей](#описание-мидлварей)
      - [CORS Middleware](#cors-middleware)
      - [HTTPS Middleware](#https-middleware)
    - [Эндпоинты](#эндпоинты)
      - [GET /](#get-)
      - [GET /key](#get-key)
    - [Пример использования](#пример-использования)
  - [install\_outline\_vpn.sh](#install_outline_vpnsh)
    - [Назначение](#назначение)
    - [Использование](#использование)
    - [Ожидаемый результат](#ожидаемый-результат)
  - [install\_nginx\_proxy.sh](#install_nginx_proxysh)
    - [Запуск скрипта:](#запуск-скрипта)
    - [Создание конфигурации Nginx:](#создание-конфигурации-nginx)

### Предварительные требования

Убедитесь, что на вашем сервере установлены следующие компоненты:

- Ubuntu Server (18.04 LTS или выше)
- Python 3.6 или выше
- pip (Python пакетный менеджер)
- sudo доступ

### Быстрая установка

Автоматизации полного процесса установки и настройки FastAPI-приложения. Эта команда включает в себя несколько подкоманд, которые выполняются последовательно для установки необходимых зависимостей, настройки виртуального окружения, создания служб и их запуска. 

```bash
make setup
```

### Установка и настройка

#### Установка зависимостей
Запустите Makefile, чтобы установить Python, pip и все зависимости проекта:

```bash
make install
make requirements
```

#### Создание виртуального окружения
Создайте виртуальное окружение для изоляции зависимостей приложения:

```bash
make create_venv
make install_venv
```

#### Настройка и запуск приложения
Используйте следующие команды Makefile для настройки и запуска вашего FastAPI-приложения:

```bash
make create_service
make reload_daemon
make enable_service
make start_service
```


### Проверка работоспособности
После запуска, проверьте статус сервиса, чтобы убедиться, что приложение работает корректно:

```bash
make status_service
```

Если всё настроено правильно, вы должны увидеть активный статус службы.

### Логи
Для просмотра логов работы приложения и сервиса перейдите в директорию логов:

```bash
cd /path/to/your/application/logs
cat access.log
cat error.log
```

### Полезные команды
Здесь перечислены некоторые полезные команды для управления приложением:

Запуск приложения: make start_service
Остановка приложения: make stop_service
Перезапуск сервиса: sudo systemctl restart your-service-name
Очистка временных файлов: make clean

### Справка
Для получения справки по доступным командам Makefile:

```bash
make help
```


## main.py

### Описание функций
```python
decode_base64(data: str) -> str
```
Функция для декодирования строки из формата Base64, добавляет необходимые символы для корректного декодирования.
```python
parse_ss_url(ss_url: str) -> dict
```
Функция для парсинга Shadowsocks URL и извлечения данных (сервер, порт, метод шифрования и пароль). Возвращает словарь с конфигурацией сервера.

Параметры:
 - ss_url — строка с URL Shadowsocks в формате ss://<encoded_user_info>@<host>:<port>
Возвращает: Словарь с конфигурацией сервера (сервер, порт, пароль и метод шифрования), либо None, если данные некорректны.
- get_config_by_id(user_id: int) -> dict
Функция, эмулирующая получение Shadowsocks URL из базы данных по идентификатору пользователя. Затем URL декодируется с помощью parse_ss_url.

### Описание мидлварей
#### CORS Middleware
Добавляет поддержку междоменных запросов. В конфигурации разрешены любые источники (allow_origins=["*"]), методы и заголовки.

#### HTTPS Middleware
Мидлварь, который проверяет, использует ли запрос протокол HTTPS. Если запрос выполнен по HTTP, происходит редирект на HTTPS с кодом состояния 307.

### Эндпоинты
#### GET /
Возвращает простое сообщение {"message": "Hello World"}.

#### GET /key
Возвращает конфигурационные данные для подключения к серверу Shadowsocks в формате JSON:

```json
{
    "server": "<server>",
    "server_port": "<port>",
    "password": "<password>",
    "method": "<encryption_method>"
}
```

Ответ при успешном запросе: 200 OK
Ответ при ошибке: 404 Not Found (если конфигурация не найдена)
### Пример использования
Запрос к эндпоинту /key вернет JSON с конфигурацией сервера:

```json
{
    "server": "109.206.241.37",
    "server_port": 56366,
    "password": "HEihmT1w0jMcIjQw7uMNaQ",
    "method": "chacha20-ietf-poly1305"
}
```

## install_outline_vpn.sh
### Назначение
Скрипт автоматизирует установку сервера VPN, основанного на платформе Outline. 
Outline — это простое решение для развертывания VPN, разработанное для повышения конфиденциальности и безопасности интернет-соединений.

### Использование
Этот скрипт выполняет установку необходимых пакетов, загружает и запускает установочный скрипт Outline VPN и выводит на экран уникальный URL-адрес для управления сервером через API.

### Ожидаемый результат
После успешного выполнения скрипта будет выведен уникальный URL-адрес API, необходимый для доступа к панели управления сервером Outline. Этот URL обычно имеет следующий вид:

```
apiUrl:<server_ip>:<port>/<unique_identifier>
```







## install_nginx_proxy.sh

Cкрипт автоматизирует установку и настройку Nginx в качестве обратного прокси-сервера для указанного доменного имени и внутреннего порта. После выполнения Nginx будет проксировать запросы с доменного имени на локальный сервер, работающий на заданном порту.


### Запуск скрипта:

```bash
bash nginx_reverse_proxy_setup.sh
```

### Создание конфигурации Nginx:

Настраивает обратный прокси на основе введённого доменного имени и внутреннего порта.
Создаёт файл конфигурации для домена и удаляет стандартный серверный блок default, если он не нужен.